<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>楊府邱府聯姻 · 雲端帶位系統</title>
    <meta name="robots" content="noindex, nofollow">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Noto+Sans+TC:wght@300;400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FDFBF9; color: #5D4D4A; }
        .font-serif { font-family: 'Cinzel', serif; }
        /* 沒滿桌：深紅色 */
        .table-active { background-color: #8E2424; color: white; transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(142, 36, 36, 0.2); }
        /* 坐滿桌：淡化處理 */
        .table-full { background-color: #F5E8E2; color: #D1B8B0; border: 1px dashed #D1B8B0; opacity: 0.5; transform: scale(0.92); }
        .aisle-bg { background-color: rgba(142, 36, 36, 0.03); }
        .modal-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="flex justify-center bg-stone-50">
    <div id="app" class="w-full max-w-md bg-white min-h-screen flex flex-col relative shadow-2xl">
        
        <!-- 狀態欄：顯示連線狀況 -->
        <div class="bg-stone-800 text-[10px] text-white px-4 py-1 flex justify-between items-center font-bold tracking-widest">
            <div class="flex items-center gap-2">
                <div id="status-dot" class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></div>
                <span id="status-text">雲端連線中...</span>
            </div>
            <span id="user-id">OFFLINE</span>
        </div>

        <!-- Header -->
        <header class="px-6 pt-8 pb-6 text-center border-b border-rose-50 bg-white">
            <h1 class="text-2xl font-serif tracking-[0.1em] uppercase mb-1 text-[#8E2424]">Wedding Usher</h1>
            <p class="text-[14px] text-stone-300 font-bold uppercase tracking-[0.8em] mb-4">楊府邱府聯姻 · 雲端即時同步</p>
            <div class="bg-white border border-rose-100 rounded-2xl px-6 py-3 inline-block shadow-sm">
                <span class="text-[10px] text-rose-300 font-black uppercase mb-1 block">即時報到統計</span>
                <span class="text-2xl font-serif font-black text-[#8E2424]" id="total-count">0</span>
                <span class="text-stone-300 text-xs font-bold">/ 250</span>
            </div>
            <div class="mt-6 relative px-2">
                <i data-lucide="search" class="absolute left-6 top-1/2 -translate-y-1/2 w-4 h-4 text-rose-200"></i>
                <input type="text" id="search" placeholder="搜尋姓名、桌號..." class="w-full bg-stone-50 border-stone-100 border rounded-2xl py-3.5 pl-12 pr-4 text-sm focus:outline-none focus:ring-1 focus:ring-rose-100">
            </div>
        </header>

        <!-- Nav Tabs -->
        <nav class="flex border-b border-rose-50 sticky top-0 bg-white/95 backdrop-blur-md z-20">
            <button onclick="tab('map')" id="t-map" class="flex-1 py-4 text-[11px] font-bold uppercase tracking-widest border-b-2 border-[#8E2424] text-[#8E2424]">地圖定位</button>
            <button onclick="tab('list')" id="t-list" class="flex-1 py-4 text-[11px] font-bold uppercase tracking-widest text-stone-300">桌次列表</button>
            <button onclick="tab('all')" id="t-all" class="flex-1 py-4 text-[11px] font-bold uppercase tracking-widest text-stone-300">賓客清單</button>
        </nav>

        <!-- Main View -->
        <main id="main-view" class="flex-1 overflow-auto p-4 bg-[#FDFBF9]"></main>

        <!-- Modal -->
        <div id="modal" class="fixed inset-0 z-[60] hidden flex items-end justify-center px-4 pb-12">
            <div class="absolute inset-0 bg-stone-900/40 backdrop-blur-sm" onclick="closeModal()"></div>
            <div class="bg-white w-full max-w-lg rounded-[3.5rem] shadow-2xl relative z-10 max-h-[85vh] flex flex-col border border-rose-50 modal-up">
                <div class="w-16 h-1 bg-stone-100 rounded-full mx-auto my-6"></div>
                <div id="modal-content" class="px-10 pb-12 overflow-auto"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 您的 Firebase Config
        const firebaseConfig = {
          apiKey: "AIzaSyCfbOv5cMQ4VKcjQenDZG5KofSlT_Cn5Xg",
          authDomain: "wedding-63f82.firebaseapp.com",
          projectId: "wedding-63f82",
          storageBucket: "wedding-63f82.firebasestorage.app",
          messagingSenderId: "575347379898",
          appId: "1:575347379898:web:ecc015f493cb3155fefc83",
          measurementId: "G-WQF1PEY9NQ"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app,"ww0117");

        // 數據結構
        const DATA = {
            '主桌': ['楊智傑', '邱馨慧', '楊朝宗', '吳孟雀', '楊廖烏糖', '吳新竹', '魏文生', '邱求', '陳永福', '陳黃素雲', '吳孟珠', '邱木水'],
            '1': [], '2': ['廖碧娥', '廖碧娥', '廖碧娥', '詹銀', '詹銀', '何銘炤', '何銘炤', '詹素梅', '詹素梅'],
            '3': ['楊寶珠', '楊寶珠', '楊寶珠', '楊寶珠', '陳金買', '陳金買', '林鳳淳', '林鳳淳'],
            '4': ['謝採緹', '謝承儒', '謝承儒', '潘素', '潘素', '曾定輝', '曾定輝', '陳錫宏', '陳錫宏', '林佳銘', '林佳銘'],
            '5': ['陳培澤', '陳培澤', '潘進興', '潘進興', '楊一峰', '楊一峰', '陳進丁', '陳進丁'],
            '6': ['陳文生', '陳文生', '陳文貴', '陳文貴', '羅明炫', '羅明炫', '羅聰立', '羅聰立', '袁嘉宏'],
            '7': ['楊鎮豪', '楊鎮豪', '楊添財', '楊添財', '楊淑玲', '楊淑玲', '楊淑玲', '楊淑玲'],
            '8': ['楊慶忠', '楊慶忠', '楊慶忠', '楊慶忠', '楊淑芬', '楊淑芬', '楊淑芬', '楊淑芬', '楊淑芬', '楊淑芬'],
            '9': ['許仁吉', '許仁吉', '曾仲仁', '曾仲仁', '蔡承憲', '蔡承憲', '邱子庭', '邱子庭', '黃建軍', '曾榆涵'],
            '10': ['邱仲晟', '魏昱銘', '鄧詠仁', '李承叡', '陳均璿', '蔡汶錡', '蔡汶錡', '劉德彥', '劉德彥', '劉德彥', '劉德彥'],
            '11': ['楊雅婷', '楊雅婷', '蕭展智', '蕭展智', '蕭展智', '楊雅惠', '魏秋香', '楊凱鈞', '楊凱鈞', '楊凱鈞', '楊凱鈞'],
            '12': ['張柏', '張柏', '張柏鎧', '張柏鎧', '黃信文', '廖晨涵', '廖晨涵', '王怡雯', '廖智億', '廖智億', '廖智億'],
            '13': ['劉冠麟', '劉冠麟', '陳巧宣', '陳巧宣', '許宏宇', '許宏宇', '倪紹熙', '陳建良', '陳建良', '潘任翔', '潘任翔'],
            '14': ['楊慶榮', '楊慶榮', '楊慶榮', '楊慶榮', '鄭明富', '鄭明富', '鄭芝宜', '鄭新逸', '鄭新逸', '邱妙玲', '邱詩容'],
            '15': ['黃語琪', '黃語琪', '程薌營', '王佳貞', '鄭維方', '簡吟潔', '林彥廷', '林彥廷', '廖一久', '廖一久', '廖一久'],
            '16': ['蘇志成', '蘇志成', '李正雄', '李正雄', '翁于捷', '侯怡帆', '張郁欣', '陳以凌', '蔡淑花'],
            '17': ['吳文城', '吳文城', '吳文城', '梁如杰', '梁如杰', '梁如杰', '梁如杰', '梁家寧', '梁家寧', '黃雅婷', '王文珠'],
            '18': ['陳清雲', '陳清雲', '陳清雲', '陳震洋', '陳震洋', '陳震洋', '陳家煊', '陳家煊', '陳家'],
            '19': ['王雅靖', '王雅靖', '王雅靖', '李悅寧', '李悅寧', '李悅寧', '施立璇', '施立璇', '施立璇', '葉明', '葉明', '陳彥廷'],
            '20': ['簡定國', '張炳煌', '張炳煌', '張炳富', '張炳富', '張炳裕', '陳雍華', '陳明夏', '陳明夏'],
            '21': [], '22': ['周啟諒', '邱木發', '邱木發', '邱木發', '邱建德', '邱建森', '溫俊明'],
            '23': ['施錫坤', '施錫坤', '施錫坤', '施秀鶴', '施秀鶴', '施秀鶴', '施秀香', '施秀香', '施秀香'],
            '24': ['劉溪雄', '劉溪雄', '侯清利', '侯清利', '簡莉玲', '彭希偉', '黃南國', '朱家儀'],
        };

        const GRID = [
            { id: '1', r: 1, c: 1 }, { id: '7', r: 1, c: 3 }, { id: '主桌', r: 1, c: 5 }, { id: '17', r: 1, c: 7 }, { id: '21', r: 1, c: 9 },
            { id: '4', r: 2, c: 2 }, { id: '11', r: 2, c: 4 }, { id: 'A', r: 2, c: 5 }, { id: '14', r: 2, c: 6 },
            { id: '2', r: 3, c: 1 }, { id: '8', r: 3, c: 3 }, { id: 'A', r: 3, c: 5 }, { id: '18', r: 3, c: 7 }, { id: '22', r: 3, c: 8 },
            { id: '5', r: 4, c: 2 }, { id: '12', r: 4, c: 4 }, { id: 'A', r: 4, c: 5 }, { id: '15', r: 4, c: 6 },
            { id: '3', r: 5, c: 1 }, { id: '9', r: 5, c: 3 }, { id: 'A', r: 5, c: 5 }, { id: '19', r: 5, c: 7 }, { id: '23', r: 5, c: 9 },
            { id: '6', r: 6, c: 2 }, { id: '13', r: 6, c: 4 }, { id: 'A', r: 6, c: 5 }, { id: '16', r: 6, c: 6 },
            { id: '10', r: 7, c: 3 }, { id: 'A', r: 7, c: 5 }, { id: '20', r: 7, c: 7 }, { id: '24', r: 7, c: 8 },
        ];

        let stateKeys = new Set();
        let currentTab = 'map';
        let activeTableId = null;
        function setStatus(ok, msg) {
  const dot = document.getElementById('status-dot');
  const text = document.getElementById('status-text');
  dot.className = ok
    ? "w-2 h-2 rounded-full bg-green-500"
    : "w-2 h-2 rounded-full bg-red-500 animate-pulse";
  text.innerText = msg;
}
        
        // 初始化：連線與監聽
        async function start() {
          try {
            const cred = await signInAnonymously(auth);
            document.getElementById('user-id').innerText =
              "ID: " + cred.user.uid.substring(0, 6);
        
            const docRef = doc(db, "wedding_attendance", "global_status");
        
            // ✅ 先確保文件存在（避免某些情況下讀得到但資料結構空）
            const initSnap = await getDoc(docRef);
               if (!initSnap.exists()) {await setDoc(docRef, { keys: [] }, { merge: true });}
        
            onSnapshot(
              docRef,
              (snap) => {
                const data = snap.data() || {};
                stateKeys = new Set(Array.isArray(data.keys) ? data.keys : []);
        
                setStatus(true, "雲端同步中 (ONLINE)");
        
                render();
                if (activeTableId) updateModal(activeTableId);
              },
              (err) => {
                console.error("Snapshot error:", err);
                setStatus(false, `同步失敗: ${err.code || ""} ${err.message || err}`);
              }
            );
          } catch (err) {
            console.error("Start Error:", err);
            setStatus(false, `登入/初始化失敗: ${err.code || ""} ${err.message || err}`);
          }
        }

        // 寫入雲端（✅ 不互蓋、不會被別人刷新影響）
window.toggleCloud = async (tid, name) => {
  const key = `${tid}-${name}`;
  const docRef = doc(db, "wedding_attendance", "global_status");
  const arrived = stateKeys.has(key);

  try {
    await setDoc(
      docRef,
      { keys: arrived ? arrayRemove(key) : arrayUnion(key) },
      { merge: true }
    );
  } catch (err) {
    console.error("Write fail:", err);
    setStatus(false, `寫入失敗: ${err.code || ""} ${err.message || err}`);
    alert("無法寫入資料庫：" + (err.message || err));
  }
};

        function render() {
            const main = document.getElementById('main-view');
            const term = document.getElementById('search').value.toLowerCase();
            
            let total = 0;
            Object.entries(DATA).forEach(([tid, list]) => {
                const unique = aggregate(list);
                unique.forEach(u => { if(stateKeys.has(`${tid}-${u.name}`)) total += u.count; });
            });
            document.getElementById('total-count').innerText = total;

            if (term) { renderSearch(main, term); return; }
            if (currentTab === 'map') renderMap(main);
            else if (currentTab === 'list') renderList(main);
            else renderAll(main);
            lucide.createIcons();
        }

        window.tab = (v) => {
            currentTab = v;
            document.querySelectorAll('nav button').forEach(b => b.className = "flex-1 py-4 text-[11px] font-bold uppercase tracking-widest text-stone-300");
            document.getElementById(`t-${v}`).className = "flex-1 py-4 text-[11px] font-bold uppercase tracking-widest border-b-2 border-[#8E2424] text-[#8E2424]";
            render();
        };

        function renderMap(container) {
            let html = `<div class="p-6 bg-white rounded-[3rem] shadow-xl border border-rose-50 grid grid-cols-9 gap-1.5 relative overflow-hidden">`;
            for (let i = 0; i < 63; i++) {
                const r = Math.floor(i / 9) + 1, c = (i % 9) + 1;
                const cell = GRID.find(g => g.r === r && g.c === c);
                if (cell?.id === 'A') html += `<div class="aisle-bg flex items-center justify-center opacity-30"><span class="rotate-90 text-[5px] font-bold">Aisle</span></div>`;
                else if (cell) {
                    const full = isFull(cell.id);
                    html += `<button onclick="openT('${cell.id}')" class="w-10 h-10 rounded-full flex items-center justify-center font-serif text-[10px] font-bold transition-all ${full ? 'table-full' : 'table-active'}">${cell.id === '主桌' ? '主' : cell.id}</button>`;
                } else html += `<div class="w-10 h-10"></div>`;
            }
            container.innerHTML = html + `</div>`;
        }

        function renderList(container) {
            let html = `<div class="space-y-3">`;
            Object.keys(DATA).sort((a,b) => (a==='主桌'?-1:b==='主桌'?1:parseInt(a)-parseInt(b))).forEach(tid => {
                const full = isFull(tid);
                html += `<div onclick="openT('${tid}')" class="bg-white p-5 rounded-[2.5rem] border flex items-center justify-between shadow-sm transition-all ${full ? 'opacity-40' : 'border-rose-100 ring-1 ring-rose-50'}"><div class="flex items-center gap-6"><div class="w-14 h-14 rounded-2xl flex items-center justify-center font-serif text-xl ${full ? 'bg-stone-50 text-stone-200' : 'bg-[#8E2424] text-white'}">${tid==='主桌'?'M':tid}</div><div><h3 class="font-bold text-stone-700">Table ${tid}</h3><div class="flex gap-2 mt-1"><span class="text-[9px] text-stone-300 font-bold uppercase tracking-widest">${aggregate(DATA[tid]).length} 代表人</span>${full ? '<span class="text-[9px] text-[#8E2424] font-black uppercase flex items-center gap-1 tracking-widest"><i data-lucide="check" class="w-3 h-3"></i> FULL</span>' : ''}</div></div></div><i data-lucide="chevron-right" class="w-5 h-5 text-stone-200"></i></div>`;
            });
            container.innerHTML = html + `</div>`;
        }

        function renderAll(container) {
            let html = `<div class="bg-white rounded-[2.5rem] overflow-hidden border border-stone-50 shadow-xl">`;
            const all = [];
            Object.entries(DATA).forEach(([tid, list]) => aggregate(list).forEach(r => all.push({...r, tid})));
            all.sort((a,b) => (a.tid==='主桌'?-1:b.tid==='主桌'?1:parseInt(a.tid)-parseInt(b.tid))).forEach(r => {
                const ok = stateKeys.has(`${r.tid}-${r.name}`);
                html += `<div onclick="openT('${r.tid}')" class="flex items-center justify-between px-8 py-5 border-b border-stone-50 active:bg-rose-50/20"><div class="flex items-center gap-5"><div class="w-10 h-10 rounded-full flex items-center justify-center ${ok?'text-stone-200':'bg-white text-rose-300 shadow-sm border border-rose-50'}">${ok?'<i data-lucide="check"></i>':'<i data-lucide="user"></i>'}</div><span class="text-lg font-bold ${ok?'text-stone-300 line-through':'text-stone-700'}">${r.name} ${r.count>1?`<span class="text-xs text-rose-300"> +${r.count-1}位</span>`:''}</span></div><span class="text-[9px] bg-rose-50 text-[#8E2424] px-3 py-1.5 rounded-full font-black">T-${r.tid==='主桌'?'M':r.tid}</span></div>`;
            });
            container.innerHTML = html + `</div>`;
        }

        function renderSearch(container, term) {
            let html = `<div class="space-y-3">`;
            const res = [];
            Object.entries(DATA).forEach(([tid, list]) => aggregate(list).forEach(r => { if(r.name.includes(term)||tid.includes(term)) res.push({...r, tid}); }));
            res.forEach(r => { html += `<div onclick="openT('${r.tid}')" class="bg-white p-5 rounded-[2rem] border border-stone-100 flex items-center justify-between shadow-sm"><div class="flex items-center gap-5"><div class="w-12 h-12 rounded-2xl bg-[#8E2424] flex items-center justify-center text-white font-serif">${r.tid==='主桌'?'M':r.tid}</div><div><div class="font-bold text-lg">${r.name}</div><div class="text-[9px] text-stone-300 uppercase mt-1">Table ${r.tid}</div></div></div><i data-lucide="chevron-right" class="w-5 h-5 text-stone-200"></i></div>`; });
            container.innerHTML = html + `</div>`;
        }

        window.openT = (tid) => {
            activeTableId = tid;
            updateModal(tid);
            document.getElementById('modal').style.display = 'flex';
        };

        function updateModal(tid) {
            const list = DATA[tid];
            const unique = aggregate(list);
            let html = `<div class="flex items-center gap-6 mb-8"><div class="w-16 h-16 rounded-[2rem] flex items-center justify-center text-white font-serif text-3xl shadow-xl bg-[#8E2424]">${tid === '主桌' ? 'M' : tid}</div><div><h2 class="text-2xl font-serif text-stone-800 tracking-wider">Table ${tid}</h2><span class="text-[10px] font-bold text-stone-300 uppercase tracking-widest">共 ${list.length} 人</span></div></div><div class="space-y-4">`;
            unique.forEach(u => {
                const ok = stateKeys.has(`${tid}-${u.name}`);
                html += `<div onclick="toggleCloud('${tid}', '${u.name}')" class="flex items-center justify-between p-6 rounded-[2.5rem] border transition-all ${ok?'opacity-40 bg-stone-50/50':'bg-white border-rose-50 shadow-sm'}"><div class="flex items-center gap-5"><div class="w-10 h-10 rounded-full flex items-center justify-center ${ok?'text-stone-200':'bg-rose-50 text-rose-800'}"><i data-lucide="user"></i></div><div><div class="text-xl font-bold ${ok?'text-stone-300 line-through':'text-stone-700'}">${u.name}</div>${u.count>1?`<div class="text-[10px] text-rose-400 font-bold mt-1">含親友共 ${u.count} 位</div>`:''}</div></div><div class="w-8 h-8 rounded-full border-2 flex items-center justify-center ${ok?'bg-stone-100 border-stone-100':'border-rose-100'}">${ok?'<i data-lucide="check" class="w-4 h-4 text-stone-300"></i>':''}</div></div>`;
            });
            document.getElementById('modal-content').innerHTML = html + `</div>`;
            lucide.createIcons();
        }

        window.closeModal = () => { document.getElementById('modal').style.display = 'none'; activeTableId = null; };
        function aggregate(list) { const c = {}; list.forEach(n => c[n]=(c[n]||0)+1); return Object.entries(c).map(([name,count])=>({name,count})); }
        function isFull(tid) { const list=DATA[tid]; if(!list || list.length===0) return false; return [...new Set(list)].every(n => stateKeys.has(`${tid}-${n}`)); }
        document.getElementById('search').addEventListener('input', render);
        start();
    </script>
    <footer style="
  text-align:center;
  padding:12px 12px calc(14px + env(safe-area-inset-bottom));
  color: rgba(93, 77, 74, 0.65);
  background: rgba(253, 251, 249, 0.94);
  border-top: 1px solid rgba(142, 36, 36, 0.10);
  backdrop-filter: blur(8px);
">
  <div style="font-size:12px; font-weight:700;">
    西西製作 © 2026
  </div>
  <div style="
    margin-top:4px;
    font-size:11px;
    letter-spacing:0.18em;
    font-family:'Cinzel', serif;
    color: rgba(142, 36, 36, 0.70);
  ">
    祝福新人 白頭偕老．永結同心
  </div>
</footer>
</body>
</html>

